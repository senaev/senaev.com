# ClusterSecretStore: cluster-wide gateway for External Secrets Operator to read from Vault.
# Apply AFTER Vault is unsealed and Kubernetes auth is configured (see k8s/vault-bootstrap.sh).
# ESO uses the referenced ServiceAccount's token to authenticate to Vault via Kubernetes auth.
---
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: vault
  # No namespace: ClusterSecretStore is cluster-scoped.
spec:
  provider:
    vault:
      server: "http://vault.vault.svc.cluster.local:8200"
      path: "secret"           # KV v2 mount path (see k8s/vault-bootstrap.sh)
      version: v2
      # ESO sends the ServiceAccount JWT to Vault; Vault validates it with the K8s API and issues a token.
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "external-secrets"
          serviceAccountRef:
            name: "external-secrets"
            namespace: "vault"
  # Optional: retry and refresh.
  retrySettings:
    maxRetries: 10
    retryInterval: "30s"
